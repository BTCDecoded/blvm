name: Create Prerelease

on:
  workflow_call:
    inputs:
      version_tag:
        description: 'Version tag for prerelease (e.g., v0.1.0-alpha.1)'
        required: true
        type: string
      platform:
        description: 'Platform to build for (linux, windows, or both)'
        required: false
        default: 'both'
        type: string
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag for prerelease (e.g., v0.1.0-alpha.1)'
        required: true
        type: string
      platform:
        description: 'Platform to build for (linux, windows, or both)'
        required: false
        default: 'both'
        type: string

permissions:
  contents: write
  actions: read

jobs:
  prerelease:
    name: Create Prerelease ${{ inputs.version_tag }}
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 120
    steps:
      - name: Checkout bllvm
        uses: actions/checkout@v4
        with:
          repository: BTCDecoded/bllvm
          path: bllvm
          ref: main
          fetch-depth: 0
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Check for performance tools and configure environment
        run: |
          echo "Checking for performance optimization tools..."
          RUSTFLAGS_BASE="-C debuginfo=0"
          if command -v mold &> /dev/null; then
            echo "✅ mold linker found"
            echo "RUSTFLAGS=${RUSTFLAGS_BASE} -C link-arg=-fuse-ld=mold" >> $GITHUB_ENV
          else
            echo "⚠️  mold linker not found (install for faster linking)"
            echo "RUSTFLAGS=${RUSTFLAGS_BASE}" >> $GITHUB_ENV
          fi
          if command -v ccache &> /dev/null; then
            echo "✅ ccache found"
            echo "CC=ccache gcc" >> $GITHUB_ENV
            echo "CXX=ccache g++" >> $GITHUB_ENV
          else
            echo "⚠️  ccache not found (install for faster C dependency builds)"
            # Explicitly unset CC/CXX to prevent build failures when ccache is not available
            # This ensures cargo uses the default system compiler
            echo "CC=" >> $GITHUB_ENV
            echo "CXX=" >> $GITHUB_ENV
          fi
      
      - name: Fix corrupted cargo dependencies and config
        run: |
          # Update rustup and toolchain (cargo comes with the toolchain)
          rustup update stable || true
          # CRITICAL: Unset CARGO_BUILD_JOBS if it's 0 (cargo rejects this)
          if [ "${CARGO_BUILD_JOBS:-}" = "0" ]; then
            echo "⚠️  CARGO_BUILD_JOBS is set to 0, unsetting it..."
            unset CARGO_BUILD_JOBS
            # Remove from GITHUB_ENV if it exists
            if [ -f "$GITHUB_ENV" ]; then
              sed -i '/^CARGO_BUILD_JOBS=/d' "$GITHUB_ENV" || true
            fi
          fi
          # Remove jobs=0 from config files (cargo rejects this)
          # Check for various formats: jobs=0, jobs = 0, jobs= 0, jobs =0
          if [ -f ~/.cargo/config.toml ]; then
            if grep -qE "jobs\s*=\s*0" ~/.cargo/config.toml 2>/dev/null; then
              echo "⚠️  Found jobs=0 in ~/.cargo/config.toml, removing it..."
              sed -i -E '/jobs\s*=\s*0/d' ~/.cargo/config.toml || true
            fi
          fi
          # Remove jobs=0 from workspace config files
          find . -name "config.toml" -path "*/.cargo/*" 2>/dev/null | while read file; do
            if grep -qE "jobs\s*=\s*0" "$file" 2>/dev/null; then
              echo "⚠️  Found jobs=0 in $file, removing it..."
              sed -i -E '/jobs\s*=\s*0/d' "$file" || true
            fi
          done
          # Remove incremental from config files when using sccache
          if [ "${RUSTC_WRAPPER:-}" = "sccache" ]; then
            if [ -f ~/.cargo/config.toml ]; then
              if grep -q "incremental" ~/.cargo/config.toml 2>/dev/null; then
                echo "⚠️  Removing incremental from ~/.cargo/config.toml (sccache requirement)"
                sed -i '/\[build\]/,/^\[/ { /incremental/d; }' ~/.cargo/config.toml || true
                sed -i '/^incremental/d' ~/.cargo/config.toml || true
              fi
            fi
            find . -name "config.toml" -path "*/.cargo/*" 2>/dev/null | while read file; do
              if grep -q "incremental" "$file" 2>/dev/null; then
                echo "⚠️  Removing incremental from $file (sccache requirement)"
                sed -i '/incremental/d' "$file" || true
              fi
            done
            unset CARGO_INCREMENTAL || true
          fi
          # Only clean cargo registry if explicitly needed (rust-cache handles caching)
          # This step is kept for emergency recovery but should rarely be needed
          if [ "${FORCE_CLEAN_CARGO_REGISTRY:-false}" = "true" ]; then
            echo "⚠️  FORCE_CLEAN_CARGO_REGISTRY=true, cleaning cargo registry..."
            rm -rf ~/.cargo/registry/src/* 2>/dev/null || true
            rm -rf ~/.cargo/registry/cache/* 2>/dev/null || true
            rm -rf ~/.cargo/git/db/* 2>/dev/null || true
            rm -rf ~/.cargo/git/checkouts/* 2>/dev/null || true
            echo "Cargo registry cleaned, dependencies will be re-downloaded"
          else
            echo "✅ Using rust-cache for dependency management (set FORCE_CLEAN_CARGO_REGISTRY=true to force clean)"
          fi
      
      - name: Checkout all repos at version
        run: |
          chmod +x bllvm/scripts/*.sh
          bllvm/scripts/setup-build-env.sh ${{ inputs.version_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
          PARENT_DIR: ${{ github.workspace }}
      
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust-prerelease"
          cache-all-crates: true
          save-if: ${{ github.ref == 'refs/heads/main' }}
      
      - name: Install Windows target and toolchain for cross-compilation
        if: ${{ inputs.platform == 'windows' || inputs.platform == 'both' }}
        run: |
          # Install Rust Windows target
          rustup target add x86_64-pc-windows-gnu
          
          # Install MinGW-w64 toolchain (standard for Linux cross-compilation)
          # This provides the GCC linker and tools needed for Windows binaries
          if command -v apt-get &> /dev/null; then
            # Debian/Ubuntu
            sudo apt-get update -qq
            sudo apt-get install -y -qq gcc-mingw-w64-x86-64 || {
              echo "⚠️  Failed to install gcc-mingw-w64-x86-64, trying alternative..."
              sudo apt-get install -y -qq mingw-w64 || true
            }
          elif command -v yum &> /dev/null; then
            # RHEL/CentOS/Fedora
            sudo yum install -y -q mingw64-gcc || {
              echo "⚠️  Trying dnf..."
              sudo dnf install -y -q mingw64-gcc || true
            }
          elif command -v pacman &> /dev/null; then
            # Arch Linux
            sudo pacman -S --noconfirm mingw-w64-gcc || true
          else
            echo "⚠️  Package manager not recognized, MinGW may need manual installation"
          fi
          
          # Verify MinGW installation (check both command -v and direct path)
          if command -v x86_64-w64-mingw32-gcc &> /dev/null || [ -f /usr/bin/x86_64-w64-mingw32-gcc ]; then
            MINGW_GCC=$(command -v x86_64-w64-mingw32-gcc 2>/dev/null || echo "/usr/bin/x86_64-w64-mingw32-gcc")
            if [ -x "$MINGW_GCC" ]; then
              echo "✅ MinGW-w64 GCC found: $($MINGW_GCC --version | head -n1)"
              echo "   Location: $MINGW_GCC"
            else
              echo "⚠️  MinGW-w64 GCC found but not executable: $MINGW_GCC"
            fi
          else
            echo "⚠️  MinGW-w64 GCC not found in PATH or /usr/bin, builds may fail"
            echo "   Expected: x86_64-w64-mingw32-gcc"
          fi
          
          # Configure Cargo to use MinGW linker (check if config exists first)
          mkdir -p ~/.cargo
          
          # Check if the target section already exists
          if [ -f ~/.cargo/config.toml ] && grep -q "\[target.x86_64-pc-windows-gnu\]" ~/.cargo/config.toml; then
            echo "⚠️  Windows target config already exists in ~/.cargo/config.toml, skipping..."
            echo "   If builds fail, manually verify the config is correct"
          else
            # Append or create config (using echo to avoid YAML parsing issues)
            {
              echo '[target.x86_64-pc-windows-gnu]'
              echo 'linker = "x86_64-w64-mingw32-gcc"'
              echo 'ar = "x86_64-w64-mingw32-ar"'
            } >> ~/.cargo/config.toml
            echo "✅ Added Windows target configuration to ~/.cargo/config.toml"
          fi
          
          # Verify the config is valid
          if cargo config get target.x86_64-pc-windows-gnu.linker &> /dev/null; then
            echo "✅ Windows cross-compilation environment configured"
            echo "   Linker: $(cargo config get target.x86_64-pc-windows-gnu.linker 2>/dev/null || echo 'not set')"
          else
            echo "⚠️  Could not verify Cargo config, but continuing..."
          fi
      
      - name: Build base variant (Linux)
        if: ${{ inputs.platform == 'linux' || inputs.platform == 'both' }}
        run: |
          # CRITICAL: Unset CARGO_BUILD_JOBS if it's 0 (cargo rejects this)
          if [ "${CARGO_BUILD_JOBS:-}" = "0" ]; then
            echo "⚠️  CARGO_BUILD_JOBS is set to 0, unsetting it..."
            unset CARGO_BUILD_JOBS
          fi
          bllvm/build.sh --mode release --variant base
          
          # Save hashes from first build for deterministic verification
          echo "Saving hashes from first build for deterministic verification..."
          cd ${{ github.workspace }}
          for repo in bllvm bllvm-sdk; do
            if [ -d "$repo" ] && [ -d "$repo/target/release" ]; then
              cd "$repo"
              find target/release -maxdepth 1 -type f -executable -print0 | xargs -0 sha256sum > /tmp/${repo}-build1-hashes.txt 2>/dev/null || true
              if [ -f "Cargo.lock" ]; then
                sha256sum Cargo.lock >> /tmp/${repo}-build1-hashes.txt 2>/dev/null || true
              fi
              cd - > /dev/null
            fi
          done
        env:
          PARENT_DIR: ${{ github.workspace }}
          RUSTFLAGS: "-C debuginfo=0"  # Reduce debug info for faster builds
      
      - name: Build experimental variant (Linux)
        if: ${{ inputs.platform == 'linux' || inputs.platform == 'both' }}
        run: |
          # CRITICAL: Unset CARGO_BUILD_JOBS if it's 0 (cargo rejects this)
          if [ "${CARGO_BUILD_JOBS:-}" = "0" ]; then
            echo "⚠️  CARGO_BUILD_JOBS is set to 0, unsetting it..."
            unset CARGO_BUILD_JOBS
          fi
          bllvm/build.sh --mode release --variant experimental
        env:
          PARENT_DIR: ${{ github.workspace }}
          RUSTFLAGS: "-C debuginfo=0"  # Reduce debug info for faster builds
      
      - name: Build base variant (Windows cross-compile)
        if: ${{ inputs.platform == 'windows' || inputs.platform == 'both' }}
        run: |
          cd ${{ github.workspace }}
          FAILED_REPOS=()
          
          for repo in bllvm bllvm-sdk; do
            if [ -d "$repo" ]; then
              echo "Building $repo for Windows (base variant)..."
              cd "$repo"
              
              # Build with appropriate features (bllvm-sdk doesn't have production feature)
              # Cargo config already set up MinGW linker, no need to unset CC/CXX
              if [ "$repo" = "bllvm" ]; then
                # bllvm has production feature
                if cargo build --release --target x86_64-pc-windows-gnu --features production; then
                  echo "✅ Successfully built $repo for Windows (base)"
                else
                  echo "❌ Windows build failed for $repo (base variant)"
                  FAILED_REPOS+=("$repo")
                fi
              else
                # bllvm-sdk uses default features (no production feature)
                if cargo build --release --target x86_64-pc-windows-gnu; then
                  echo "✅ Successfully built $repo for Windows (base)"
                else
                  echo "❌ Windows build failed for $repo (base variant)"
                  FAILED_REPOS+=("$repo")
                fi
              fi
              cd ..
            fi
          done
          
          if [ ${#FAILED_REPOS[@]} -gt 0 ]; then
            echo "⚠️  Some Windows builds failed: ${FAILED_REPOS[*]}"
            exit 1
          fi
        env:
          PARENT_DIR: ${{ github.workspace }}
          CARGO_INCREMENTAL: "1"
          RUSTFLAGS: "-C debuginfo=0"  # Reduce debug info for faster builds
      
      - name: Build experimental variant (Windows cross-compile)
        if: ${{ inputs.platform == 'windows' || inputs.platform == 'both' }}
        run: |
          cd ${{ github.workspace }}
          FAILED_REPOS=()
          
          for repo in bllvm bllvm-sdk; do
            if [ -d "$repo" ]; then
              echo "Building $repo for Windows (experimental variant)..."
              cd "$repo"
              
              # Build with experimental features
              if [ "$repo" = "bllvm" ]; then
                # bllvm inherits from bllvm-node, need to build with experimental features
                if cargo build --release --target x86_64-pc-windows-gnu --features production,utxo-commitments,ctv,dandelion,stratum-v2,bip158,sigop,iroh; then
                  echo "✅ Successfully built $repo for Windows (experimental)"
                else
                  echo "❌ Windows build failed for $repo (experimental variant)"
                  FAILED_REPOS+=("$repo")
                fi
              else
                # bllvm-sdk uses default features
                if cargo build --release --target x86_64-pc-windows-gnu --all-features; then
                  echo "✅ Successfully built $repo for Windows (experimental)"
                else
                  echo "❌ Windows build failed for $repo (experimental variant)"
                  FAILED_REPOS+=("$repo")
                fi
              fi
              cd ..
            fi
          done
          
          if [ ${#FAILED_REPOS[@]} -gt 0 ]; then
            echo "⚠️  Some Windows builds failed: ${FAILED_REPOS[*]}"
            exit 1
          fi
        env:
          PARENT_DIR: ${{ github.workspace }}
          CARGO_INCREMENTAL: "1"
          RUSTFLAGS: "-C debuginfo=0"  # Reduce debug info for faster builds
      
      - name: Verify deterministic builds (Linux base variant)
        if: ${{ inputs.platform == 'linux' || inputs.platform == 'both' }}
        continue-on-error: true
        timeout-minutes: 30
        run: |
          echo "=== Verifying Deterministic Builds (Base Variant) ==="
          echo "This step verifies that builds are reproducible by rebuilding and comparing hashes"
          echo "Note: This doubles build time but ensures reproducibility"
          
          PARENT_DIR="${GITHUB_WORKSPACE}"
          FAILED_REPOS=()
          
          for repo in bllvm bllvm-sdk; do
            if [ -d "${PARENT_DIR}/${repo}" ] && [ -f "/tmp/${repo}-build1-hashes.txt" ]; then
              echo "Verifying deterministic build for ${repo} (base variant)..."
              cd "${PARENT_DIR}/${repo}"
              
              # Clean and rebuild with same flags as first build
              # Use the same feature flags as build.sh uses for base variant
              cargo clean
              export CARGO_INCREMENTAL="${CARGO_INCREMENTAL:-1}"
              
              # Determine features based on repo (matching build.sh logic)
              if [ "$repo" = "bllvm" ] || [ "$repo" = "bllvm-consensus" ] || [ "$repo" = "bllvm-protocol" ] || [ "$repo" = "bllvm-node" ]; then
                # These repos have production feature
                BUILD_CMD="cargo build --release --locked --features production"
              else
                # bllvm-sdk uses default features
                BUILD_CMD="cargo build --release --locked"
              fi
              
              if eval "$BUILD_CMD" 2>&1 | tee /tmp/${repo}-rebuild.log; then
                # Generate second hash set
                find target/release -maxdepth 1 -type f -executable -print0 | xargs -0 sha256sum > /tmp/${repo}-build2-hashes.txt 2>/dev/null || true
                if [ -f "Cargo.lock" ]; then
                  sha256sum Cargo.lock >> /tmp/${repo}-build2-hashes.txt 2>/dev/null || true
                fi
                
                # Compare (sort both files for consistent comparison)
                sort /tmp/${repo}-build1-hashes.txt > /tmp/${repo}-build1-sorted.txt 2>/dev/null || true
                sort /tmp/${repo}-build2-hashes.txt > /tmp/${repo}-build2-sorted.txt 2>/dev/null || true
                
                if diff -q /tmp/${repo}-build1-sorted.txt /tmp/${repo}-build2-sorted.txt > /dev/null 2>&1; then
                  echo "✅ ${repo} (base): Deterministic build verified - hashes match"
                else
                  echo "⚠️  WARNING: ${repo} (base): Non-deterministic build detected"
                  echo "First build hashes:"
                  cat /tmp/${repo}-build1-sorted.txt || true
                  echo "Second build hashes:"
                  cat /tmp/${repo}-build2-sorted.txt || true
                  FAILED_REPOS+=("${repo}")
                fi
              else
                echo "⚠️  WARNING: ${repo} (base): Rebuild failed, skipping verification"
                echo "Rebuild log (last 50 lines):"
                tail -50 /tmp/${repo}-rebuild.log || true
                FAILED_REPOS+=("${repo}")
              fi
              cd - > /dev/null
            else
              echo "⚠️  WARNING: ${repo} (base): No first build hashes found, skipping verification"
            fi
          done
          
          if [ ${#FAILED_REPOS[@]} -gt 0 ]; then
            echo "⚠️  WARNING: Some builds failed deterministic verification: ${FAILED_REPOS[*]}"
            echo "This is non-blocking for Phase 1 prerelease, but should be fixed for production releases"
            echo "Common causes: timestamps in binaries, non-deterministic compilation order"
          else
            echo "✅ All deterministic builds verified (base variant)"
          fi
        env:
          PARENT_DIR: ${{ github.workspace }}
          RUSTFLAGS: "-C debuginfo=0"
      
      - name: Run tests (skip doctests for Phase 1 prerelease)
        run: |
          cd ${{ github.workspace }}
          FAILED_REPOS=()
          
          for repo in bllvm-consensus bllvm-protocol bllvm-node bllvm-sdk; do
            if [ -d "$repo" ]; then
              echo "=========================================="
              echo "Running tests in $repo (skipping doctests and CI-problematic tests)..."
              echo "=========================================="
              cd "$repo"
              
              # First, try to build tests to catch compilation errors early
              echo "Building tests for $repo..."
              if ! cargo build --release --all-features --tests 2>&1 | tee /tmp/${repo}-test-build.log; then
                echo "❌ Test compilation failed in $repo"
                echo "Build log (last 100 lines):"
                tail -100 /tmp/${repo}-test-build.log || true
                FAILED_REPOS+=("$repo")
                cd ..
                continue
              fi
              
              echo "✅ Tests compiled successfully for $repo"
              echo "Running tests..."
              
              # Skip doctests for Phase 1 prerelease
              # --lib --bins --tests excludes --doc (doctests)
              # Skip tests that hang in CI environment
              # Use timeout command to prevent hanging tests (30 min total per repo)
              # Run tests with single thread to avoid resource contention
              # Skip tests that hang in CI - use filter to exclude them
              # The test was removed but --skip is harmless if test doesn't exist
              if timeout 1800 cargo test --release --all-features --lib --bins --tests -- --test-threads=1 --skip test_handle_incoming_wire_tcp_enqueues_pkgtxn 2>&1 | tee /tmp/${repo}-test_output.log; then
                echo "✅ Tests passed for $repo"
              else
                EXIT_CODE=$?
                if [ $EXIT_CODE -eq 124 ]; then
                  echo "❌ Tests timed out in $repo (exceeded 30 minutes)"
                  echo "Last 100 lines of test output:"
                  tail -100 /tmp/${repo}-test_output.log || true
                else
                  echo "❌ Tests failed in $repo"
                  echo "Last 100 lines of test output:"
                  tail -100 /tmp/${repo}-test_output.log || true
                fi
                FAILED_REPOS+=("$repo")
              fi
              cd ..
            fi
          done
          
          if [ ${#FAILED_REPOS[@]} -gt 0 ]; then
            echo ""
            echo "❌ Tests failed in the following repos: ${FAILED_REPOS[*]}"
            exit 1
          else
            echo ""
            echo "✅ All tests passed"
          fi
        env:
          PARENT_DIR: ${{ github.workspace }}
          CI: true
          GITHUB_ACTIONS: true
          RUSTFLAGS: "-C debuginfo=0"
      
      - name: Collect artifacts (base variant)
        run: |
          if [ "${{ inputs.platform }}" = "linux" ] || [ "${{ inputs.platform }}" = "both" ]; then
            bllvm/scripts/collect-artifacts.sh linux-x86_64 base
          fi
          if [ "${{ inputs.platform }}" = "windows" ] || [ "${{ inputs.platform }}" = "both" ]; then
            bllvm/scripts/collect-artifacts.sh windows-x86_64 base
          fi
      
      - name: Collect artifacts (experimental variant)
        run: |
          # Only collect bllvm binary for experimental (governance tools are the same, collected in base)
          if [ "${{ inputs.platform }}" = "linux" ] || [ "${{ inputs.platform }}" = "both" ]; then
            bllvm/scripts/collect-artifacts.sh linux-x86_64 experimental
          fi
          if [ "${{ inputs.platform }}" = "windows" ] || [ "${{ inputs.platform }}" = "both" ]; then
            bllvm/scripts/collect-artifacts.sh windows-x86_64 experimental
          fi
      
      - name: Validate artifacts exist
        run: |
          BLLVM_DIR="${GITHUB_WORKSPACE}/bllvm"
          ARTIFACTS_DIR="${BLLVM_DIR}/artifacts"
          MISSING_ARTIFACTS=0
          
          echo "=== Validating Artifacts ==="
          
          # Check for expected binaries based on platform (both variants)
          if [ "${{ inputs.platform }}" = "linux" ] || [ "${{ inputs.platform }}" = "both" ]; then
            echo "Checking Linux bllvm binary (base variant)..."
            if [ ! -d "${ARTIFACTS_DIR}/bllvm-linux" ] || [ -z "$(ls -A ${ARTIFACTS_DIR}/bllvm-linux 2>/dev/null)" ]; then
              echo "❌ ERROR: Linux bllvm binary directory not found or empty: ${ARTIFACTS_DIR}/bllvm-linux"
              MISSING_ARTIFACTS=1
            else
              LINUX_BLLVM=$(find "${ARTIFACTS_DIR}/bllvm-linux" -type f -executable 2>/dev/null | wc -l)
              echo "✅ Found $LINUX_BLLVM bllvm binary(ies) (base)"
            fi
            
            echo "Checking Linux bllvm binary (experimental variant)..."
            if [ ! -d "${ARTIFACTS_DIR}/bllvm-experimental-linux" ] || [ -z "$(ls -A ${ARTIFACTS_DIR}/bllvm-experimental-linux 2>/dev/null)" ]; then
              echo "❌ ERROR: Linux experimental bllvm binary directory not found or empty: ${ARTIFACTS_DIR}/bllvm-experimental-linux"
              MISSING_ARTIFACTS=1
            else
              LINUX_EXP_BLLVM=$(find "${ARTIFACTS_DIR}/bllvm-experimental-linux" -type f -executable 2>/dev/null | wc -l)
              echo "✅ Found $LINUX_EXP_BLLVM bllvm binary(ies) (experimental)"
            fi
            
            echo "Checking Linux governance tools (single variant)..."
            if [ -d "${ARTIFACTS_DIR}/governance-linux" ] && [ "$(ls -A ${ARTIFACTS_DIR}/governance-linux 2>/dev/null)" ]; then
              LINUX_GOV=$(find "${ARTIFACTS_DIR}/governance-linux" -type f -executable 2>/dev/null | wc -l)
              echo "✅ Found $LINUX_GOV governance tool(s)"
            else
              echo "⚠️  WARNING: Linux governance tools directory not found or empty"
            fi
          fi
          
          if [ "${{ inputs.platform }}" = "windows" ] || [ "${{ inputs.platform }}" = "both" ]; then
            echo "Checking Windows bllvm binary (base variant)..."
            if [ ! -d "${ARTIFACTS_DIR}/bllvm-windows" ] || [ -z "$(ls -A ${ARTIFACTS_DIR}/bllvm-windows 2>/dev/null)" ]; then
              echo "❌ ERROR: Windows bllvm binary directory not found or empty: ${ARTIFACTS_DIR}/bllvm-windows"
              MISSING_ARTIFACTS=1
            else
              WINDOWS_BLLVM=$(find "${ARTIFACTS_DIR}/bllvm-windows" -type f -name "*.exe" 2>/dev/null | wc -l)
              echo "✅ Found $WINDOWS_BLLVM bllvm binary(ies) (base)"
            fi
            
            echo "Checking Windows bllvm binary (experimental variant)..."
            if [ ! -d "${ARTIFACTS_DIR}/bllvm-experimental-windows" ] || [ -z "$(ls -A ${ARTIFACTS_DIR}/bllvm-experimental-windows 2>/dev/null)" ]; then
              echo "❌ ERROR: Windows experimental bllvm binary directory not found or empty: ${ARTIFACTS_DIR}/bllvm-experimental-windows"
              MISSING_ARTIFACTS=1
            else
              WINDOWS_EXP_BLLVM=$(find "${ARTIFACTS_DIR}/bllvm-experimental-windows" -type f -name "*.exe" 2>/dev/null | wc -l)
              echo "✅ Found $WINDOWS_EXP_BLLVM bllvm binary(ies) (experimental)"
            fi
            
            echo "Checking Windows governance tools (single variant)..."
            if [ -d "${ARTIFACTS_DIR}/governance-windows" ] && [ "$(ls -A ${ARTIFACTS_DIR}/governance-windows 2>/dev/null)" ]; then
              WINDOWS_GOV=$(find "${ARTIFACTS_DIR}/governance-windows" -type f -name "*.exe" 2>/dev/null | wc -l)
              echo "✅ Found $WINDOWS_GOV governance tool(s)"
            else
              echo "⚠️  WARNING: Windows governance tools directory not found or empty"
            fi
          fi
          
          # Check for SHA256SUMS files (new naming scheme)
          SHA256SUMS_FOUND=0
          for checksum_file in "${ARTIFACTS_DIR}"/SHA256SUMS-*; do
            if [ -f "$checksum_file" ]; then
              echo "✅ Found $(basename "$checksum_file")"
              SHA256SUMS_FOUND=1
            fi
          done
          
          if [ "$SHA256SUMS_FOUND" -eq 0 ]; then
            echo "⚠️  WARNING: No SHA256SUMS files found"
          fi
          
          # Check for RELEASE_NOTES.md
          if [ ! -f "${ARTIFACTS_DIR}/RELEASE_NOTES.md" ]; then
            echo "⚠️  WARNING: RELEASE_NOTES.md not found (will be created by create-release.sh)"
          else
            echo "✅ Found RELEASE_NOTES.md"
          fi
          
          if [ "$MISSING_ARTIFACTS" -ne 0 ]; then
            echo ""
            echo "❌ Artifact validation failed - missing required artifacts"
            exit 1
          fi
          
          echo ""
          echo "✅ Artifact validation passed"
      
      - name: Verify artifact checksums (if available)
        run: |
          BLLVM_DIR="${GITHUB_WORKSPACE}/bllvm"
          ARTIFACTS_DIR="${BLLVM_DIR}/artifacts"
          
          echo "=== Verifying Artifact Checksums ==="
          
          # Verify checksums for each directory/checksum pair
          for checksum_file in "${ARTIFACTS_DIR}"/SHA256SUMS-*; do
            if [ ! -f "$checksum_file" ]; then
              continue
            fi
            
            checksum_name=$(basename "$checksum_file")
            echo "Verifying checksums for $checksum_name..."
            
            # Determine which directory to check based on checksum filename
            if [[ "$checksum_name" == *"bllvm-linux"* ]]; then
              check_dir="${ARTIFACTS_DIR}/bllvm-linux"
            elif [[ "$checksum_name" == *"bllvm-experimental-linux"* ]]; then
              check_dir="${ARTIFACTS_DIR}/bllvm-experimental-linux"
            elif [[ "$checksum_name" == *"bllvm-windows"* ]]; then
              check_dir="${ARTIFACTS_DIR}/bllvm-windows"
            elif [[ "$checksum_name" == *"bllvm-experimental-windows"* ]]; then
              check_dir="${ARTIFACTS_DIR}/bllvm-experimental-windows"
            else
              echo "⚠️  WARNING: Unknown checksum file format: $checksum_name"
              continue
            fi
            
            if [ -d "$check_dir" ]; then
              cd "$check_dir"
              if sha256sum -c "$checksum_file" 2>/dev/null; then
                echo "✅ Checksums verified for $checksum_name"
              else
                echo "⚠️  WARNING: Checksum verification failed for $checksum_name (continuing...)"
              fi
              cd - > /dev/null
            else
              echo "⚠️  WARNING: Directory not found for $checksum_name: $check_dir"
            fi
          done
        continue-on-error: true
      
      - name: Create release package
        run: |
          bllvm/scripts/create-release.sh ${{ inputs.version_tag }}
      
      - name: Verify versions
        run: |
          bllvm/scripts/verify-versions.sh
      
      - name: Validate release artifacts before publishing
        run: |
          BLLVM_DIR="${GITHUB_WORKSPACE}/bllvm"
          ARTIFACTS_DIR="${BLLVM_DIR}/artifacts"
          VERSION_TAG="${{ inputs.version_tag }}"
          
          echo "=== Final Artifact Validation ==="
          
          # Check that release package files exist
          REQUIRED_FILES=0
          FOUND_FILES=0
          
          if [ "${{ inputs.platform }}" = "linux" ] || [ "${{ inputs.platform }}" = "both" ]; then
            # Check bllvm binaries (base + experimental)
            REQUIRED_FILES=$((REQUIRED_FILES + 2))
            if [ -f "${ARTIFACTS_DIR}/bllvm-${VERSION_TAG}-linux-x86_64.tar.gz" ]; then
              echo "✅ Found bllvm Linux binary (base)"
              FOUND_FILES=$((FOUND_FILES + 1))
            else
              echo "❌ ERROR: bllvm Linux base binary not found"
            fi
            if [ -f "${ARTIFACTS_DIR}/bllvm-experimental-${VERSION_TAG}-linux-x86_64.tar.gz" ]; then
              echo "✅ Found bllvm Linux binary (experimental)"
              FOUND_FILES=$((FOUND_FILES + 1))
            else
              echo "❌ ERROR: bllvm Linux experimental binary not found"
            fi
            
            # Governance tools are now included in bllvm archives, no separate archive needed
          fi
          
          if [ "${{ inputs.platform }}" = "windows" ] || [ "${{ inputs.platform }}" = "both" ]; then
            # Check bllvm binaries (base + experimental)
            REQUIRED_FILES=$((REQUIRED_FILES + 2))
            if [ -f "${ARTIFACTS_DIR}/bllvm-${VERSION_TAG}-windows-x86_64.zip" ]; then
              echo "✅ Found bllvm Windows binary (base)"
              FOUND_FILES=$((FOUND_FILES + 1))
            else
              echo "❌ ERROR: bllvm Windows base binary not found"
            fi
            if [ -f "${ARTIFACTS_DIR}/bllvm-experimental-${VERSION_TAG}-windows-x86_64.zip" ]; then
              echo "✅ Found bllvm Windows binary (experimental)"
              FOUND_FILES=$((FOUND_FILES + 1))
            else
              echo "❌ ERROR: bllvm Windows experimental binary not found"
            fi
            
            # Governance tools are now included in bllvm archives, no separate archive needed
          fi
          
          # Check for SHA256SUMS files (at least one should exist)
          SHA256SUMS_FOUND=0
          for checksum in SHA256SUMS-bllvm-* SHA256SUMS-bllvm-experimental-*; do
            if [ -f "${ARTIFACTS_DIR}/${checksum}" ]; then
              SHA256SUMS_FOUND=1
              break
            fi
          done
          if [ "$SHA256SUMS_FOUND" -eq 1 ]; then
            echo "✅ Found SHA256SUMS file(s)"
            FOUND_FILES=$((FOUND_FILES + 1))
          else
            echo "⚠️  WARNING: No SHA256SUMS files found"
          fi
          
          # Check for RELEASE_NOTES.md
          if [ -f "${ARTIFACTS_DIR}/RELEASE_NOTES.md" ]; then
            echo "✅ Found RELEASE_NOTES.md"
            FOUND_FILES=$((FOUND_FILES + 1))
          else
            echo "❌ ERROR: RELEASE_NOTES.md not found"
          fi
          
          if [ "$FOUND_FILES" -lt "$((REQUIRED_FILES + 1))" ]; then
            echo ""
            echo "❌ Release artifact validation failed"
            echo "Found $FOUND_FILES required files, expected at least $((REQUIRED_FILES + 1))"
            exit 1
          fi
          
          echo ""
          echo "✅ All required release artifacts validated"
      
      - name: Verify files exist before release
        run: |
          BLLVM_DIR="${GITHUB_WORKSPACE}/bllvm"
          ARTIFACTS_DIR="${BLLVM_DIR}/artifacts"
          VERSION_TAG="${{ inputs.version_tag }}"
          
          echo "=== Verifying files exist before release ==="
          
          # List all files that will be uploaded
          echo "Archive files (bllvm and bllvm-experimental, both tar.gz and zip):"
          find "${ARTIFACTS_DIR}" -maxdepth 1 -type f \( -name "bllvm-${VERSION_TAG}-*.tar.gz" -o -name "bllvm-${VERSION_TAG}-*.zip" -o -name "bllvm-experimental-${VERSION_TAG}-*.tar.gz" -o -name "bllvm-experimental-${VERSION_TAG}-*.zip" \) -ls
          
          echo ""
          echo "Checksum files:"
          find "${ARTIFACTS_DIR}" -maxdepth 1 -type f -name "SHA256SUMS-*" -ls
          
          echo ""
          echo "✅ All release files verified"
      
      - name: Create GitHub Prerelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version_tag }}
          name: BTCDecoded ${{ inputs.version_tag }} (Prerelease)
          body_path: bllvm/artifacts/RELEASE_NOTES.md
          files: |
            bllvm/artifacts/bllvm-${{ inputs.version_tag }}-*.tar.gz
            bllvm/artifacts/bllvm-${{ inputs.version_tag }}-*.zip
            bllvm/artifacts/bllvm-experimental-${{ inputs.version_tag }}-*.tar.gz
            bllvm/artifacts/bllvm-experimental-${{ inputs.version_tag }}-*.zip
            bllvm/artifacts/SHA256SUMS-bllvm-*
            bllvm/artifacts/SHA256SUMS-bllvm-experimental-*
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}

