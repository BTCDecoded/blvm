name: Verify Consensus (Reusable)

on:
  workflow_call:
    inputs:
      repo:
        required: false
        type: string
        default: consensus-proof
      kani:
        required: false
        type: boolean
        default: true
      ref:
        required: true
        type: string
      timeout_minutes:
        required: false
        type: number
        default: 120

permissions:
  contents: read
  actions: read

env:
  RUST_BACKTRACE: '1'
  CARGO_TERM_COLOR: 'always'
  CI: 'true'
  CARGO_INCREMENTAL: '1'

jobs:
  verify:
    # Kani is installed dynamically, so we only need rust label
    runs-on: [self-hosted, Linux, X64, perf]
    timeout-minutes: ${{ inputs.timeout_minutes }}
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ inputs.repo }}
          ref: ${{ inputs.ref }}

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo test (all features)
        run: cargo test --all-features --locked

      - name: Install Kani (if enabled)
        if: ${{ inputs.kani }}
        run: |
          curl -fsSL https://model-checking.github.io/kani/install.sh | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run Kani proofs
        if: ${{ inputs.kani }}
        run: |
          cargo kani --features verify || true

      - name: Upload logs (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verify-logs
          path: |
            target/**/*.log
            kani-*.log
