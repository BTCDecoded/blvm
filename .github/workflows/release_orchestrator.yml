name: Release Orchestrator

on:
  workflow_dispatch:
    inputs:
      set_ref:
        description: 'Ref/tag to use for all repos (optional, falls back to versions.toml)'
        required: false
        default: ''
  repository_dispatch:
    types: [build_consensus, build_protocol, build_node, build_sdk, build_governance, build_all]
  workflow_run:
    workflows: 
      - "CI"
      - "Build"
      - "Release"
    types: [completed]
    branches: [main, master]

permissions:
  contents: read
  actions: read
  packages: write

jobs:
  read-versions:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      cp: ${{ steps.parse.outputs.cp }}
      pe: ${{ steps.parse.outputs.pe }}
      rn: ${{ steps.parse.outputs.rn }}
      ds: ${{ steps.parse.outputs.ds }}
      ga: ${{ steps.parse.outputs.ga }}
    steps:
      - uses: actions/checkout@v4
      - name: Parse versions.toml
        id: parse
        run: |
          # Parse versions.toml using new repo names
          # Format: bllvm-consensus = { version = "0.1.0", git_tag = "v0.1.0", ... }
          CP=$(grep -A 1 "bllvm-consensus" versions.toml | grep "git_tag" | sed -E 's/.*git_tag = "([^"]+)".*/\1/' | head -1)
          PE=$(grep -A 1 "bllvm-protocol" versions.toml | grep "git_tag" | sed -E 's/.*git_tag = "([^"]+)".*/\1/' | head -1)
          RN=$(grep -A 1 "bllvm-node" versions.toml | grep "git_tag" | sed -E 's/.*git_tag = "([^"]+)".*/\1/' | head -1)
          DS=$(grep -A 1 "bllvm-sdk" versions.toml | grep "git_tag" | sed -E 's/.*git_tag = "([^"]+)".*/\1/' | head -1)
          GA=$(grep -A 1 "governance-app" versions.toml | grep "git_tag" | sed -E 's/.*git_tag = "([^"]+)".*/\1/' | head -1)
          echo "cp=$CP" >> $GITHUB_OUTPUT
          echo "pe=$PE" >> $GITHUB_OUTPUT
          echo "rn=$RN" >> $GITHUB_OUTPUT
          echo "ds=$DS" >> $GITHUB_OUTPUT
          echo "ga=$GA" >> $GITHUB_OUTPUT

  verify-consensus:
    needs: read-versions
    uses: ./.github/workflows/verify_consensus_cached.yml
    with:
      repo: bllvm-consensus
      kani: true
      ref: ${{ needs.read-versions.outputs.cp }}
      use_cache: true
      timeout_minutes: 120

  build-protocol:
    needs: verify-consensus
    uses: ./.github/workflows/build_lib_cached.yml
    with:
      repo: bllvm-protocol
      package: bllvm-protocol
      ref: ${{ needs.read-versions.outputs.pe }}
      features: ""
      release: true
      verify_deterministic: false
      use_cache: true
      timeout_minutes: 60

  build-node:
    needs: build-protocol
    uses: ./.github/workflows/build_lib_cached.yml
    with:
      repo: bllvm-node
      package: bllvm-node
      ref: ${{ needs.read-versions.outputs.rn }}
      features: ""
      release: true
      verify_deterministic: false
      use_cache: true
      timeout_minutes: 90

  build-sdk:
    needs: build-node
    uses: ./.github/workflows/build_lib_cached.yml
    with:
      repo: bllvm-sdk
      package: bllvm-sdk
      ref: ${{ needs.read-versions.outputs.ds }}
      features: ""
      release: true
      verify_deterministic: false
      use_cache: true
      timeout_minutes: 60

  build-governance-app-image:
    needs: build-sdk
    uses: ./.github/workflows/build_docker.yml
    with:
      repo: bllvm-commons
      context: .
      image_name: governance-app
      push: false
      ref: ${{ needs.read-versions.outputs.ga }}
      tag: ${{ needs.read-versions.outputs.ga }}
      use_cache: true
      timeout_minutes: 30

  trigger-release:
    needs: build-governance-app-image
    if: success()
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Determine release type
        id: release-type
        run: |
          # Check if this is main branch (official release) or other (prerelease)
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
            echo "type=official" >> $GITHUB_OUTPUT
            echo "Triggering official release for main branch"
          else
            echo "type=prerelease" >> $GITHUB_OUTPUT
            DATE=$(date +%Y%m%d)
            COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            VERSION="nightly-${DATE}-${COMMIT}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "Triggering prerelease for branch: $BRANCH"
          fi
      
      - name: Trigger official release
        if: steps.release-type.outputs.type == 'official'
        uses: ./.github/workflows/release.yml
        with:
          platform: both
      
      - name: Trigger prerelease
        if: steps.release-type.outputs.type == 'prerelease'
        uses: ./.github/workflows/prerelease.yml
        with:
          version_tag: ${{ steps.release-type.outputs.version }}
          platform: both

  deploy-signal:
    needs: [build-governance-app-image, trigger-release]
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Send deployment signal to governance-app self-hosted runner
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REPO_ACCESS_TOKEN || secrets.ORG_PAT || secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: 'bllvm-commons',  # GitHub repo name (was governance-app)
              event_type: 'deploy',
              client_payload: { 
                tag: '${{ needs.read-versions.outputs.ga }}',
                image: '${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository_owner }}/governance-app:${{ needs.read-versions.outputs.ga }}'
              }
            })
